#!/bin/bash

set -x
source ./config.sh


create_team() {
  echo "Creating team $TEAM_NAME in the $ORG organization..."

  gh api -X POST "orgs/$ORG/teams" \
    -H "Accept: application/vnd.github+json" \
    -F name="$TEAM_NAME" \
    -F description="Team responsible for managing the website repository." \
    -F privacy="closed"
}

add_user_to_team() {
  echo "Adding $USERNAME to the $TEAM_NAME team..."

  gh api -X PUT "orgs/$ORG/teams/$TEAM_NAME/memberships/$USERNAME" \
    -H "Accept: application/vnd.github+json"
}

set_team_repo_permissions() {
  echo "Setting $TEAM_NAME team permissions to maintain for the $REPO repository..."

  gh api -X PUT "orgs/$ORG/teams/$TEAM_NAME/repos/$REPO" \
    -H "Accept: application/vnd.github+json" \
    -F permission="maintain"
}

team() {
  create_team
  add_user_to_team
  set_team_repo_permissions
  echo "Team setup and repository permissions complete!"
}

gh_login() {
  echo "Logging in to GitHub..."
  gh auth login
}

set_branch_protection() {
  echo "Setting branch protection rules for $BRANCH branch of $REPO..."
  
  gh api -X PUT "repos/$REPO/branches/$BRANCH/protection" \
    -H "Accept: application/vnd.github+json" \
    -H "X-GitHub-Api-Version: 2022-11-28" \
    -F allow_deletions=false \
    -F allow_force_pushes=false \
    -F enforce_admins=true \
    -F "required_pull_request_reviews[required_approving_review_count]=1" \
    -F "required_status_checks[strict]=true" \
    -F "restrictions[users][]=" \
    -F "restrictions[teams][]=$TEAM_NAME" \
    -F "restrictions[apps][]"
}

set_default_branch() {
  echo "Setting default branch to $BRANCH for repository $REPO..."
  
  gh api -X PATCH "repos/$REPO" -F "default_branch=$BRANCH"
}

main() {
  gh_login
  set_branch_protection
  set_default_branch
  echo "Automation complete!"
}

team
main

